<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-type" content="text/html; charset=UTF-8">
        <script src="hebcal.min.js"></script>
        <title>Calculateur</title>
        <script>
var lastDateSelector = null;
var dateSelector = null;

function startNewCycle() {
    if(!confirm("Démarrer un nouveau cycle ?")) {
        return;
    }
    var lastCycleDate = new Date(lastDateSelector.value);
    var newCycleDate = new Date(dateSelector.value);

    var dateRanges = computeDates(newCycleDate, lastCycleDate);
    
    setCalendarReminders(dateRanges);
    
    setCookie(newCycleDate);
}

function computeDates(newDate, lastDate) {
    var result = [];

    var newHebrewDate = getHebrewDate(newDate);
    var lastHebrewDate = isDateValid(lastDate) ? getHebrewDate(lastDate) : null;

    result.push(computeDate30(newHebrewDate));
    result.push(computeDateFromMonth(newHebrewDate));
    result.push(computeDateFromLast(newHebrewDate, lastHebrewDate));
    result = filterDates(result);

    var newCycleDuringDay = isDay(newDate);
  
    return getDateRanges(result, newCycleDuringDay);
}

function getHebrewDate(date) {
    var hebrewDate = Hebcal.HDate(date);
    if (hebrewDate.getZemanim().shkiah < date) hebrewDate = hebrewDate.next();
    return hebrewDate;
}

function isDateValid(date) {
    return date != null && date != "Invalid Date";
}

function computeDate30(hebrewDate) {
    return addDaysToHebrewDate(hebrewDate, 30);
}

function addDaysToHebrewDate(date, nbDays) {
    var result = Hebcal.HDate(date.greg());
    for(i = 0; i<nbDays; i++) result = result.next();
    return result;
}

function computeDateFromMonth(hebrewDate) {
    var daysInMonth = hebrewDate.getMonthObject().length;
    var newDate = addDaysToHebrewDate(hebrewDate, daysInMonth);
    if(newDate.getDate() != hebrewDate.getDate()) return null;
    return newDate;
}

function computeDateFromLast(newHebrewDate, lastHebrewDate) {
    if(lastHebrewDate == null) {
      alert("Attention: impossible de calculer une des dates sans connaitre le début du cycle précédent");
      return null;
    }
    var nbDaysBetween = getDaysBetweenHebrewDates(lastHebrewDate, newHebrewDate);
    return addDaysToHebrewDate(newHebrewDate, nbDaysBetween);
}

function getDaysBetweenHebrewDates(fromDate, toDate) {
    return Math.round((toDate.greg() - fromDate.greg())/864E5);
}

function filterDates(hebrewDates) {
    var result = hebrewDates
        .filter(x => x != null)
        .map(x => x.getZemanim().chatzot.getTime());
    result = result
        .filter((x,i) => result.indexOf(x) == i)
        .map(x => new Date(x))
        .map(getHebrewDate);
    return result;
}

function isDay(gregorianDate) {
    var hebDate = Hebcal.HDate(gregorianDate);
    if (hebDate.getZemanim().shkiah < gregorianDate) return false;
    return hebDate.getZemanim().neitz_hachama <= gregorianDate;
}

function getDateRanges(hebrewDates, useDayPeriod) {
    return hebrewDates.map(x => getDateRange(x, useDayPeriod));
}

function getDateRange(hebrewDate, useDayPeriod) {
    if (useDayPeriod)
        return [hebrewDate.getZemanim().neitz_hachama, hebrewDate.getZemanim().shkiah];
    else
        return [hebrewDate.getZemanim().shkiah, hebrewDate.next().getZemanim().neitz_hachama];
}

function setCalendarReminders(dateRanges) {
    var data = ['BEGIN:VCALENDAR','VERSION:2.0'];
    
    dateRanges.map(x => {
      var startTime = x[0];
      var endTime = x[1];
      data.push('BEGIN:VEVENT');
      data.push('URL:' + document.URL);
      data.push('DTSTART:' + startTime.toISOString().replace(/-|:|\.\d+/g, ''));
      data.push('DTEND:' + endTime.toISOString().replace(/-|:|\.\d+/g, ''));
      data.push('SUMMARY:Pricha');
      data.push('DESCRIPTION:');
      data.push('END:VEVENT');
    });

    data.push('END:VCALENDAR');

    var href = encodeURI('data:text/calendar;charset=utf8,' + data.join('\n'));

    document.getElementById("new-cal").innerHTML += 
        '<a target="_blank" href="' + href + '">Ajouter un rappel pour les ' + dateRanges.length + ' dates</a>' + 
        '<ul>' +
        dateRanges.map(x => '<li> Du ' + x[0].toLocaleString() + ' au ' + x[1].toLocaleString() + '</li>').join('') +
        '<ul>';
}

function setCookie(date) {
    var data = '{"last": "' + date.getTime() + '"}';
    writeCookie(data);
}

function writeCookie(data) {
    document.cookie = "cookie=" + data + "; expires=Sat, Feb 01 2200 12:00:00 UTC; path=/";
}

        </script>
    </head>
    <body>
        <h1 style="width: 100%; text-align: center;">Date du dernier cycle:</h1>
        <p align="center">
            <input type="datetime-local" id="lastDateSelector" name="lastDateSelector" />
        </p>
        <h1 style="width: 100%; text-align: center;">Date du nouveau cycle:</h1>
        <p align="center">
            <input type="datetime-local" id="dateSelector" name="dateSelector" />
        </p>
        <hr/>
        <p style="width: 100%; text-align: center;">
            <input style="width: 200px; height: 100px;" type="button" value="Démarrer un nouveau cycle" onclick="startNewCycle();"/>
        </p>
        <div id="new-cal"></div>
        <script>

function getElement(id) {
    return document.getElementById(id);
}

function setCalendarValue(cal, date) {
    if(!isDateValid(date)) return;
    cal.value = date2Text(date);
}

function pad2(value) {
    return ("00" + value).substr(-2);
}

function date2Text(date) {
    return date.getFullYear() + "-" + 
        pad2(date.getMonth() + 1) + "-" +
        pad2(date.getDate()) + "T" + 
        pad2(date.getHours()) + ":" + 
        pad2(date.getMinutes()) + ":" + 
        pad2(date.getSeconds());
}

function readCookie() {
    return document.cookie.split("; ").filter(x=>x.startsWith("cookie="))[0];
}

function getDateFromCookie() {
    var cookie = null;
    eval(readCookie());
    if(cookie == null) return null;
    var lastDate = new Date(+cookie.last);
    return lastDate;
}

lastDateSelector = getElement("lastDateSelector");
dateSelector = getElement("dateSelector");

setCalendarValue(lastDateSelector, getDateFromCookie());
setCalendarValue(dateSelector, new Date());
        </script>
    </body>
</html>
